from __future__ import print_function
import pygmsh
import os, subprocess
from distutils.spawn import find_executable

#------------------------------------------------------------------------
class Geometry(pygmsh.built_in.Geometry):
  def __init__(self, **kwargs):
    self.datatype = 'binary'
    self.npartitions = 0
    self.hmean = 1.0
    self.dim = 3
    if 'datatype' in kwargs: self.datatype = kwargs.pop('datatype')
    if 'name' in kwargs: self.name = kwargs.pop('name')
    if 'npartitions' in kwargs: self.npartitions = kwargs.pop('npartitions')
    if 'hmean' in kwargs: self.hmean = kwargs.pop('hmean')
    if 'dim' in kwargs: self.dim = kwargs.pop('dim')
    print("@@@@@@@@  hmean",self.hmean)
    pygmsh.built_in.Geometry.__init__(self, kwargs)
    self.gmsh_executable = pygmsh.helpers._get_gmsh_exe()
    if find_executable(self.gmsh_executable) is None:
        import sys
        print("no gmsh executable found: {}".format(self.gmsh_executable))
        sys.exit(1)
    self.defineGeometry()
#------------------------------------------------------------------------
  def runGeo(self, outdir=None, name=None):
    if outdir is None : outdir = os.getcwd()
    if name is None : name = self.name
    # print("@@@@@@@@ name %s" %name)
    if not os.path.isdir(outdir) : os.mkdir(outdir)
    filenamegeo = os.path.join(outdir,name + '.geo')
    # print("@@@@@@@@ filenamegeo %s" %filenamegeo)
    file = open(filenamegeo, "w")
    # file.write(self.get_code().encode())
    file.write(self.get_code())
    file.close()
  def runGmsh(self, outdir=None, name=None, verbose = True, num_lloyd_steps=3):
    if outdir is None : outdir = os.getcwd()
    if name is None : name = self.name
    filenamegeo = os.path.join(outdir,name + '.geo')
    self.runGeo(outdir, name)
    filenamemsh = os.path.join(outdir,name+'.msh')
    # cmd = [self.gmsh_executable, '-'+str(self.dim), filenamegeo, '-o', filenamemsh]
    cmd = [self.gmsh_executable]
    cmd += ["-{:1d}".format(self.dim)]
    cmd += ["{}".format(filenamegeo)]
    cmd += ["-o"]
    cmd += ["{}".format(filenamemsh)]
    cmd += ["-format"]
    cmd += ["{}".format("msh2")]
    if self.npartitions>0:
      cmd += ['-part', str(self.npartitions), '-oneFilePerPart']
    # if self.datatype != 'ascii':
    #   cmd += ['-bin']
    print("### Format is ASCII for the moment, need to work on format 4")
    # cmd += ["-format {}".format("msh2")]
    p = subprocess.Popen(cmd, stdin=None, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = p.communicate()
    # if verbose:
    #   while True:
    #     line = p.stdout.readline()
    #     if not line: break
    #     print(line, end='')
    if stderr != "":
      print("cmd=",cmd)
      print("cmd=",' '.join(cmd))
      # print("stdout=",stdout)
      print("stderr=",stderr)
      raise RuntimeError('Gmsh exited with error (return code %d).' %p.returncode)
